---
title: "Exercises Day 8"
author: "Sara Ho"
date: "`r Sys.Date()`"
output: html_document
---

```{r global_options, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE,
                      cache = FALSE, tidy = FALSE)
```

### 1: Import data and packages 

Import necessary packages.
```{r}
library(tidyverse)
library(data.table)
```

Load the data
```{r}
schools <- fread(here::here("data", "nys_schools.csv"))
counties <- fread(here::here("data", "nys_acs.csv"))
```

### 2: Explore data

```{r}
summary(schools)
```

Deal with missing values, which are currently coded as `-99`.
```{r}
# since we need county level data later, let's remove schools without a county
schools <- schools[county_name != -99]

# for remaining columns, convert -99 to NA
metric_names <- c("total_enroll", "per_free_lunch", "per_reduced_lunch",
                  "per_lep", "mean_ela_score", "mean_math_score")
schools[, (metric_names) := replace(.SD, .SD == -99, NA)
        , .SDcols = metric_names]
summary(schools)
```

Address percentages (fractions) that are over 1
```{r}
schools[per_free_lunch > 1, per_free_lunch := per_free_lunch / 100]

# if there are remaining columns still over 1, remove those data points
schools[per_free_lunch > 1, per_free_lunch := NA]
summary(schools)
```

#### 3: Recoding and variable manipulation

Create a categorical variable that groups counties into "high", "medium", and "low" poverty groups.

```{r}
sum_counties <- summary(counties[,county_per_poverty])
sum_counties["1st Qu."]
sum_counties["3rd Qu."]

counties[county_per_poverty < sum_counties["1st Qu."],
         pov_cat := "low"]
counties[county_per_poverty >= sum_counties["1st Qu."],
         pov_cat := "medium"]
counties[county_per_poverty > sum_counties["3rd Qu."],
         pov_cat := "high"]
```

The tests that the NYS Department of Education administers changes from time to time, so scores are not directly comparable year-to-year. Create a new variable that is the standardized z-score for math and English Language Arts (ELA) for each year.

```{r}
schools[, z_mean_ela_score := scale(mean_ela_score), year]
schools[, z_mean_math_score := scale(mean_math_score), year]
```

Create variables that represent the total number of students in free and reduced lunch.
```{r}
schools[ , num_free_lunch := round(total_enroll * per_free_lunch)]
schools[ , num_reduced_lunch := round(total_enroll * per_reduced_lunch)]
```

#### 4: Merge datasets

Create a county-level dataset that merges variables from the schools dataset and the ACS dataset. 

```{r}
merged <- merge(schools, counties, by = c("county_name", "year"), all.x = TRUE)
```


#### Task 5: Create summary tables

For each county: total enrollment, percent of students qualifying for free or reduced price lunch, and percent of population in poverty.

First, get the number of total students per county enrolled in free or reduced lunch program:

```{r}
# mean county poverty across the years for which there is data
sum_table_1 <- merged[ , .(tot_enroll = sum(total_enroll, na.rm = TRUE),
                           tot_reduced_lunch = sum(num_reduced_lunch, na.rm = TRUE),
                           tot_free_lunch = sum(num_free_lunch, na.rm = TRUE),
                           mean_poverty = mean(county_per_poverty, na.rm = TRUE))
                       , county_name]
```

Then, convert the total numbers to percentages (fractions)

```{r}
sum_table_1[, p_reduced_lunch := tot_reduced_lunch / tot_enroll]
sum_table_1[, p_free_lunch := tot_free_lunch / tot_enroll]
sum_table_1[, tot_reduced_lunch := NULL][, tot_free_lunch := NULL]
sum_table_1
```

For the counties with the top 5 and bottom 5 poverty rate: percent of population in poverty, percent of students qualifying for free or reduced price lunch,mean reading score, and mean math score.

NOTE: the max year for counties is 2016, while the max year for schools is 2017

```{r}
# let's get the poverty rates for 2016
low_pov_counties <- counties[year == max(year)][order(county_per_poverty)] %>% slice(1:5)
high_pov_counties <- counties[year == max(year)][order(county_per_poverty, decreasing = TRUE)] %>% slice(1:5)
```

```{r}
# scores are not comparable from year to year, but they should be comparable
# from school to school as long as the years are the same!
low_pov_schools <- schools[low_pov_counties, on = "county_name"]

low_pov_sum <- low_pov_schools[ , .(tot_enroll = sum(total_enroll, na.rm = TRUE),
                     tot_reduced_lunch = sum(num_reduced_lunch, na.rm = TRUE),
                     tot_free_lunch = sum(num_free_lunch, na.rm = TRUE),
                     mean_poverty = mean(county_per_poverty, na.rm = TRUE),
                     mean_math_score = mean(mean_math_score, na.rm = TRUE),
                     mean_ela_score = mean(mean_ela_score, na.rm = TRUE))
                 , county_name][, pov_cat := "low"]

high_pov_schools <- schools[high_pov_counties, on = "county_name"]

high_pov_sum <- high_pov_schools[ , .(tot_enroll = sum(total_enroll, na.rm = TRUE),
                      tot_reduced_lunch = sum(num_reduced_lunch, na.rm = TRUE),
                      tot_free_lunch = sum(num_free_lunch, na.rm = TRUE),
                      mean_poverty = mean(county_per_poverty, na.rm = TRUE),
                      mean_math_score = mean(mean_math_score, na.rm = TRUE),
                      mean_ela_score = mean(mean_ela_score, na.rm = TRUE))
                  , county_name][, pov_cat := "high"]

sum_table_2 <- rbind(low_pov_sum, high_pov_sum)
sum_table_2
```

#### Task 6: Data visualization

The relationship between access to free/reduced price lunch and test performance, at the *school* level.

```{r}
ggplot(schools) + 
  geom_point(mapping = aes(x = per_free_lunch, y = z_mean_ela_score)) + 
  labs(title = "Percent receiving free lunch v test scores")
```


Average test performance across *counties* with high, low, and medium poverty.

```{r}
sum_table_3 <- merged[ , .(mean_ela = mean(z_mean_ela_score, na.rm = TRUE),
                           mean_math = mean(z_mean_math_score, na.rm = TRUE))
                       , pov_cat]

sum_table_3 <- melt(sum_table_3, id.vars = "pov_cat")

ggplot(sum_table_3[!is.na(pov_cat)]) + 
  geom_col(aes(x = pov_cat, y = value)) + 
  facet_wrap(~variable)
  labs(title = "average ela test scores")
```

#### Task 7: Answering questions


Using the skills you have learned in the past three days, tackle the following question: 

> What can the data tell us about the relationship between poverty and test performance in New York public schools? Has this relationship changed over time? Is this relationship at all moderated by access to free/reduced price lunch?

You may use summary tables, statistical models, and/or data visualization in pursuing an answer to this question. Feel free to build on the tables and plots you generated above in Tasks 5 and 6.

Given the short time period, any answer will of course prove incomplete. The goal of this task is to give you some room to play around with the skills you've just learned. Don't hesitate to try something even if you don't feel comfortable with it yet. Do as much as you can in the time allotted.




